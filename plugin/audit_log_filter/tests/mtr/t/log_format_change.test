
--let $audit_filter_log_path = `SELECT @@global.datadir`
--let $audit_filter_log_name = `SELECT @@global.audit_log_filter_file`

SELECT audit_log_filter_set_filter('log_all', '{"filter": {"log": true}}');
SELECT audit_log_filter_set_user('%', 'log_all');

--source generate_audit_events.inc

--let $restart_parameters="restart: --audit_log_filter_format=OLD"
--source include/restart_mysqld.inc

--let $new_name_suffix = NEW
--source rename_rotated_log.inc

--source generate_audit_events.inc

--let $restart_parameters="restart: --audit_log_filter_format=JSON"
--source include/restart_mysqld.inc

--let $new_name_suffix = OLD
--source rename_rotated_log.inc

--source generate_audit_events.inc

--let $restart_parameters="restart: --audit_log_filter_format=NEW"
--source include/restart_mysqld.inc

--let $new_name_suffix = JSON
--source rename_rotated_log.inc

# Make sure all rotated logs have valid format
--let $xml_file_path = $audit_filter_log_path
--let $xml_file_name = test_audit_filter.NEW
--source validate_xml_file.inc

--let $xml_file_name = test_audit_filter.OLD
--source validate_xml_file.inc

--let $json_file_path = $audit_filter_log_path
--let $json_file_name = test_audit_filter.JSON
--source validate_json_file.inc

--echo #
--echo # Cleanup
DELETE FROM mysql.audit_log_user;
DELETE FROM mysql.audit_log_filter;
SELECT audit_log_filter_flush();

--let $log_base_name = test_audit_filter
--remove_file $audit_filter_log_path$log_base_name.NEW
--remove_file $audit_filter_log_path$log_base_name.OLD
--remove_file $audit_filter_log_path$log_base_name.JSON
